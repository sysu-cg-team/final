# Final Project

## 项目介绍

​	该项目展示了一个在海岛搭建的小房子的场景，我们尝试在这个小场景中，实现各种功能，锻炼计算机图形学的应用能力。

## 结果展示

​	请尝试运行github仓库中的bin/release.exe来查看效果。

​	![demo](D:\code\cg\assets\demo.gif)

## 开发环境

- 开发环境: VS2017, x64计算机, opengl, glsl3.3
- 外部库: glfw3, glad, glm, assimp, stb_image，freetype

## 功能列表

### Basic:

- 摄像机漫游
- 简单光照
- 纹理映射
- 阴影映射
- 模型加载 & 网格视图

### Bonus:

- 天空盒
- 流体模拟
- 复杂光照（法线贴图与Gamma校正）
- 文字显示
- 抗锯齿
- 草地显示（使用几何着色器）

## 功能实现

#### Basic部分：

- 使用摄像机相关部分来达到视角移动的效果

- 我们在demo中使用各向异性光照（水面光照）和Phong光照模型（太阳光照）

- 在房屋的和树木模型上实现了纹理映射、阴影映射以及模型加载。

#### Bonus部分：

- **流体模拟：**流体模拟的实现方法较多，包含十分简单的正弦函数模拟流体，Gerstner波模拟，再到快速傅里叶变换实现，以及利用粒子实现等多种方法，本次流体模拟的实现主要是使用了Gerstner波，采用的光照模型是ward各向异光性模型。

  Gerstner的函数表达式如下：

  ![1563551795181](D:/code/cg/dmk/assets/1563551795181.png)

  

  Gerstner有几个比较重要的参数：

  1. 波长（L）：世界空间中波之间波峰至波峰的距离。波长L与频率w有关，w=2/L。
  2. 振幅（A）：从水面到波峰的高度。
  3. 速度（S）：波峰每秒向前移动的距离。速度可以方便地表示为相位常数φ，其中φ
     =S x 2/L。
  4. 方向（D）：垂直于波峰传播的波前的水平矢量。

  因此，我们可以构造如下结构体，方便后面使用：

  ![1563552547989](D:/code/cg/dmk/assets/1563552547989.png)

  然后根据Gerstner波函数进行计算：

  ![1563552598263](D:/code/cg/dmk/assets/1563552598263.png)

  光照模型采用的是ward各向异光性模型，Ward各向异性光照模型在一定程度上也是依赖于微表面理论作为依据，但并不严格，不过其最终还是获得了不错的效果；同时该模型也满足能量守恒和互反性。

  ![1563552648238](D:/code/cg/dmk/assets/1563552648238.png)

  Ward模型可以对大多数的材质类型获得较好的模拟，不过其在specular反射部分中并没有使用fresnel分量，因而在该部分的表现力上可能有所欠缺。因此，我添加了fresnel分量，因为这个分量对于水、金属等物体有非常好的效果，更逼近真实。Schlick Fresnel对于Fresnel来说是一个非常不错的例子。从GPU精粹第3章可以得到。

  实现效果：

- **复杂光照(法线贴图与Gamma校正):**

  我们会用一张图片来存储切空间法向量信息, 这叫法线贴图。法线贴图整体是偏蓝的, 因为它代表了切空间中原始法向量的方向, 而R和G可以表达法向量角度的偏移。法线贴图不能直接用于物体的着色器, 因为它的法向量是切空间的法向量, 不是物体空间的法向量。为了使法线贴图能够应用于我们的物体, 我们需要将物体空间的各种向量变换到切空间来进行计算(也可以从切空间变换到物体空间, 但计算会更复杂), 这个变换需要物体空间中顶点的法向量和TBN矩阵。

  ![1563553211196](D:\code\cg\assets\tex_Barrel_normal.tga.png)

- **Gamma校正:**gamma校正用的是一条公式V_out=V_in^(1/λ), 实质上它的作用为把RGB三个通道的灰度值拉高, 这样颜色就整体变亮了。

  ![gamma](D:\code\cg\assets\gamma.png)

- **草地显示:** 我们在屋子的周围模拟生成了草地,草地会随着风向摇摆,实现原理如下.

  - 首先确定草根坐标

  - 使用几何着色器生成草的网格,同时计算法向量和纹理坐标

  - 模拟草的外形.通过随机数生成不同的宽度和高度,使用alpha贴图模拟草的外形

  - 模拟风.通过全局和局部随机值生成风(vec3).根据草越靠近顶部受风影响越大的原理产生草不同部分的位移.

    ![grass](D:\code\cg\assets\grass.gif)

- **抗锯齿:** 我们使用MSAA的机制来实现抗锯齿操作, 一般情况下, 我们在光栅化的时候, 考虑该该像素的中心点是否在图元的内部, 图元内部则对对该像素着色. 但是这样在图元的边缘就形成锯齿现象.

  ![msaa1](D:\code\cg\assets\msaa2.png)

  ​	我们使用多重采样技术也就是MSAA机制来解决这个问题,我们不再是单纯使用中心点一个点来判断一个像素的颜色, 而是使用多重采用, 一个像素中存在多个采样点, 根据包含在图元内的采样点的个数觉得该像素的颜色, 从而解决锯齿化的问题.

  ​				![msaa3](D:\code\cg\assets\msaa3.png)

  我们将抗锯齿效果应用到草地上,可以得到如下对比.

  ![mass4](D:\code\cg\assets\mass4.png)

- **文字显示:** 文字显示我们使用freetype库辅助我们. 我们使用将系统的字体文件使用freetype加载后, 根据free type的定义, 设置好每个需要显示的字符的属性值(width height bearingX bearingY advance等), 之后将其作为纹理渲染到一个二维的平面上, 实现文字显示的效果. 我们使用文字渲染来显示岛上时间.

  ![type](D:\code\cg\assets\type.png)

## 遇到的问题和解决方案

​	下面是我们的实验过程中几个比较棘手的问题记录和解决方法

- **关于模型导入:**模型导入的头文件起初使用的是learnOpenGL官网上的model.h和mesh.h, 这个模型导入库只能处理漫反射贴图, 对后续的工作会产生不便, 因此我对其进行了一些改造, 使其可以处理镜面反射贴图、AO贴图和法线贴图。另外我们给model.h里的Importer的参数设置了一下, 使其自动为模型增加法向量, 虽然用这种方法添加的法向量质量不如模型自带的好, 甚至可能会出错, 不过好歹也算有法向量了。有了法向量, 后面的phong光照模型、法线贴图和阴影着色器才能发挥作用。
- **关于法线贴图:** 大部分模型是不带法线贴图的, 因此我们用blender来从漫反射贴图上bake了法线贴图
- **关于流体模拟: **在流体模拟中，因为是小组成员各自分工先完成自己的部分在进行整合，所以一开始自己写的时候效果很好，但是整合出现了很多问题，首先是因为没有绑定到VAO，导致无法显示；解决办法是, 重新独立绑定VAO, 与其他小组成员的代码独立开来, 增强鲁棒性之后成功解决问题.
- **关于文本渲染:** 文字显示的代码逻辑并不困难，但是需要使用freetype库，而配置使用这个库的过程中遇到了很多的麻烦，并且都是涉及系统dll或者开发SDK的问题，解决起来比较棘手。经过多番尝试并翻阅了大量的github issue后解决问题。然而之后整合代码的时候，发现流体模拟和文字显示存在冲突，经过排查发现是文字显示的时候设置了只显示一个面，使得流体模拟的水面只能从一个面被看到，注释掉这部分代码之后问题解决。

## 分工

| 邓子杰  | 摄像机漫游, 纹理映射, 阴影映射, 天空盒, 地形生成 |
| ------ | ---- |
| **邓茅坤** | **实现光照模型**、**实现流体模拟** |
| **陈泽键** | **模型制作、模型导入、Gamma校正** |
| **陈梓峰** | **素材收集、文字显示、抗锯齿** |


